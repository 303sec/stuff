#!/usr/bin/env python2

from pwn import *

context.update(arch="amd64", # arch="i386", arch="mips",
               endian="little", os="linux", log_level="debug",
               terminal=["tmux", "split-window", "-v", "-p 80"],)

LOCAL, REMOTE, SSH = False, False, False
TARGET=os.path.realpath("./bof")

elf = ELF(TARGET)

def exploit(r):
    if LOCAL:
        bkps = [elf.symbols["main"], ]
        cmds = []
        gdb.attach(r, '\n'.join(["break *{:#x}".format(x) for x in bkps] + cmds))

    pause()
    r.interactive()
    return


if __name__ == "__main__":
    if len(sys.argv)==6 and sys.argv[1]=="ssh":
        SSH = True
        sh = ssh(user=sys.argv[2], host=sys.argv[3], port=sys.argv[4], password=sys.argv[5])
        cwd = sh.set_working_directory(os.path.dirname(TARGET))
        r = sh.process([TARGET, ])
        log.info("Starting '{}' via ssh".format(TARGET))
    elif len(sys.argv)==3:
        REMOTE=True
        HOST, PORT = sys.argv[1], int(sys.argv[2])
        r = remote(HOST, PORT)
        log.info("Starting '{}' remotely".format(TARGET))
    else:
        LOCAL=True
        r = process([TARGET, ])
        log.info("Starting '{}' locally".format(TARGET))
    exploit(r)
    sys.exit(0)
