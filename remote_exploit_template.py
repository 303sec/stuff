#!/usr/bin/env python2

import sys, os
from pwn import *

context.update(arch="amd64", # arch="i386", arch="mips",
               endian="little", # endian = "big"
               os="linux",
               log_level="debug",
               terminal=["tmux", "split-window", "-v", "-p 85"],)

TARGET="./bof"
SESSION_TYPE=None


def exploit(r):
    pause()
    if SESSION_TYPE=="local":
        bkps = [elf.symbols["main"], ]
        cmds = []
        gdb.attach(r, execute='\n'.join(["b *{:#x}".format(x) for x in bkps] + cmds))

    r.interactive()
    return


if __name__ == "__main__":
    elf = ELF(TARGET)

    if len(sys.argv)==4 and sys.argv[1]=="ssh":
        SESSION_TYPE="ssh"
        sh = ssh(user="", host="", port=0, password="")
        cwd = sh.set_working_directory(os.path.dirname(TARGET))
        # s.run_to_end(cmd.split())
        r = sh.process([TARGET, ])
        log.info("Starting '{}' via ssh".format(TARGET))

    elif len(sys.argv)==3:
        SESSION_TYPE="remote"
        HOST, PORT = sys.argv[1], int(sys.argv[2])
        r = remote(HOST, PORT)
        log.info("Starting '{}' remotely".format(TARGET))

    else:
        SESSION_TYPE="local"
        r = process([TARGET, ])
        log.info("Starting '{}' locally".format(TARGET))

    exploit(r)
    sys.exit(0)
